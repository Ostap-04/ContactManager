@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Contacts";
    var tokens = Antiforgery.GetAndStoreTokens(Context);
}

<input type="hidden" id="af-token" value="@tokens.RequestToken" />

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Contacts</h2>
    <a class="btn btn-outline-primary" asp-controller="Contacts" asp-action="Upload">Upload CSV</a>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered align-middle" id="contactsTable">
        <thead>
        <tr>
            <th>Name</th>
            <th>DateOfBirth</th>
            <th>Married</th>
            <th>Phone</th>
            <th>Salary</th>
            <th style="width: 140px;">Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

@section Scripts
{
    <script>
        $(function () {
            const token = document.getElementById("af-token").value;

            const dataUrl = '@Url.Action("Data", "Contacts")';
            const editBaseUrl = '@Url.Action("Edit", "Contacts")';
            const deleteBaseUrl = '@Url.Action("Delete", "Contacts")';

            const table = $('#contactsTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: dataUrl,
                    type: 'POST',
                    headers: { 'RequestVerificationToken': token }
                },
                columns: [
                    { data: 'name' },
                    {
                        data: 'dateOfBirth',
                        render: function (data) {
                            if (!data) return '';
                            const s = data.toString();
                            return s.length >= 10 ? s.substring(0, 10) : s; // expect "YYYY-MM-DD" or ISO; show only date portion
                        }
                    },
                    {
                        data: 'married',
                        render: function (data) {
                            return data ? "Yes" : "No";
                        }
                    },
                    { data: 'phone' },
                    {
                        data: 'salary',
                        render: function (data) {
                            const n = Number(data);
                            return isNaN(n) ? data : n.toFixed(2);
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        render: function (data, type, row) {
                            const editUrl = `${editBaseUrl}/${row.id}`;
                            return `
                                <a class="btn btn-sm btn-primary" href="${editUrl}">Edit</a>
                                <button class="btn btn-sm btn-danger ms-1 js-del" data-id="${row.id}">Delete</button>
                            `;
                        }
                    }
                ]
            });

            $('#contactsTable').on('click', '.js-del', async function () {
                const id = $(this).data('id');
                if (!confirm('Delete this contact?')) return;

                const res = await fetch(`${deleteBaseUrl}/${id}`, {
                    method: 'DELETE',
                    headers: { 'RequestVerificationToken': token }
                });

                if (!res.ok) {
                    alert('Delete failed.');
                    return;
                }

                table.ajax.reload(null, false);
            });
        });
    </script>
}
